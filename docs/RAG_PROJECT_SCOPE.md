# üìö TeacH RAG System - Projeto Completo

## üéØ Vis√£o Geral do Projeto

### Objetivo Principal
Desenvolver um sistema RAG (Retrieval-Augmented Generation) inteligente e aut√¥nomo para potencializar a plataforma TeacH, fornecendo respostas educacionais precisas, gera√ß√£o din√¢mica de conte√∫do e redu√ß√£o progressiva da depend√™ncia de APIs externas.

### Caracter√≠sticas Fundamentais
- **Autonomia Inteligente**: Base de conhecimento auto-atualiz√°vel
- **Multi-LLM**: Suporte a m√∫ltiplos provedores de IA
- **Gest√£o Rigorosa de Custos**: Controle detalhado de gastos
- **Escalabilidade**: Arquitetura preparada para crescimento
- **Integra√ß√£o Seamless**: API robusta para comunica√ß√£o com TeacH

---

## üèóÔ∏è Arquitetura T√©cnica

### Stack Principal
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    TEACH RAG SYSTEM                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üîÑ LangGraph Workflows  ‚îÇ  üß† LangChain Core             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üìä Vector DB Layer      ‚îÇ  üîß MCP Tools Integration      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üí∞ Cost Management     ‚îÇ  üîë Multi-API Key Management   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üåê Knowledge Crawler   ‚îÇ  üìö Content Generation Engine  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Tecnologias Core
- **Framework**: LangChain + LangGraph
- **Runtime**: Python 3.11+ / Node.js 18+
- **Vector Store**: Supabase Vector (priorit√°rio)
- **Fallback**: ChromaDB + Chroma Cloud
- **Local Option**: Qdrant (compat√≠vel Vercel)
- **API Framework**: FastAPI / Express.js
- **Deploy**: Vercel / Railway / Fly.io

---

## üíæ Banco de Dados Vetorial

### Op√ß√£o 1: Supabase Vector (Recomendado)
```sql
-- Tabela principal de embeddings
CREATE TABLE knowledge_embeddings (
  id BIGSERIAL PRIMARY KEY,
  content_id VARCHAR(255) NOT NULL,
  subject VARCHAR(100) NOT NULL,
  grade_level INTEGER NOT NULL,
  content_text TEXT NOT NULL,
  embedding VECTOR(1536),
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- √çndice para busca eficiente
CREATE INDEX ON knowledge_embeddings 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

**Vantagens:**
- ‚úÖ Free tier: 500MB + 2 milh√µes de requests/m√™s
- ‚úÖ Integra√ß√£o nativa PostgreSQL
- ‚úÖ Escalabilidade autom√°tica
- ‚úÖ Compatible com Vercel

### Op√ß√£o 2: ChromaDB Cloud
```python
# Configura√ß√£o ChromaDB
import chromadb
from chromadb.config import Settings

client = chromadb.HttpClient(
    host="api.chromadb.com",
    settings=Settings(
        chroma_api_impl="chromadb.api.fastapi.FastAPI",
        chroma_server_auth_provider="token"
    )
)
```

**Vantagens:**
- ‚úÖ Free tier: 100K documentos
- ‚úÖ Otimizado para RAG
- ‚úÖ Metadados avan√ßados

### Op√ß√£o 3: Qdrant Local (Backup)
```yaml
# docker-compose.yml
version: '3.8'
services:
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant_data:/qdrant/storage
```

---

## üîß Integra√ß√£o MCP (Model Context Protocol)

### Ferramentas Dispon√≠veis
```python
from langchain_community.tools import (
    DuckDuckGoSearchRun,
    WikipediaQueryRun,
    YouTubeSearchTool,
    ArxivQueryRun
)

# Configura√ß√£o MCP Tools
mcp_tools = [
    DuckDuckGoSearchRun(),           # Pesquisa web
    WikipediaQueryRun(),             # Conhecimento enciclop√©dico
    YouTubeSearchTool(),             # Conte√∫do audiovisual
    ArxivQueryRun(),                 # Papers acad√™micos
    CustomCalculatorTool(),          # Calculadora matem√°tica
    CodeExecutorTool(),              # Execu√ß√£o de c√≥digo
    DiagramGeneratorTool(),          # Gera√ß√£o de diagramas
]
```

### Workflow de Enriquecimento
```python
from langgraph import StateGraph, END

def create_knowledge_workflow():
    workflow = StateGraph({
        "query": str,
        "subject": str,
        "grade_level": int,
        "tools_used": list,
        "enriched_content": str
    })
    
    workflow.add_node("search", web_search_node)
    workflow.add_node("validate", content_validation_node)
    workflow.add_node("enrich", content_enrichment_node)
    workflow.add_node("store", vector_storage_node)
    
    workflow.set_entry_point("search")
    workflow.add_edge("search", "validate")
    workflow.add_edge("validate", "enrich")
    workflow.add_edge("enrich", "store")
    workflow.add_edge("store", END)
    
    return workflow.compile()
```

---

## üîë Sistema Multi-API e Gest√£o de Modelos

### Estrutura de Configura√ß√£o
```json
{
  "api_providers": {
    "openai": {
      "keys": [
        {
          "id": "key_001",
          "key": "sk-...",
          "model": "gpt-4o",
          "active": true,
          "daily_limit": 100.00,
          "cost_per_1k_input": 0.01,
          "cost_per_1k_output": 0.03
        }
      ]
    },
    "anthropic": {
      "keys": [
        {
          "id": "key_002", 
          "key": "ant-...",
          "model": "claude-3-haiku",
          "active": true,
          "daily_limit": 50.00,
          "cost_per_1k_input": 0.008,
          "cost_per_1k_output": 0.024
        }
      ]
    },
    "google": {
      "keys": [
        {
          "id": "key_003",
          "key": "gem-...",
          "model": "gemini-1.5-flash",
          "active": true,
          "daily_limit": 75.00,
          "cost_per_1k_input": 0.000125,
          "cost_per_1k_output": 0.000375
        }
      ]
    },
    "openrouter": {
      "keys": [
        {
          "id": "key_004",
          "key": "or-...",
          "model": "meta-llama/llama-3.1-8b-instruct:free",
          "active": true,
          "daily_limit": 0.00,
          "cost_per_1k_input": 0.0,
          "cost_per_1k_output": 0.0
        }
      ]
    }
  }
}
```

### Balanceador de Carga Inteligente
```python
class IntelligentAPIBalancer:
    def __init__(self, config_path):
        self.config = self.load_config(config_path)
        self.usage_tracker = UsageTracker()
    
    def select_best_api(self, task_type: str, complexity: str):
        """Seleciona a melhor API baseada em custo, limite e performance"""
        available_apis = self.get_available_apis()
        
        if task_type == "simple_qa" and complexity == "low":
            # Prioriza APIs gratuitas para tarefas simples
            return self.select_cheapest_api(available_apis)
        elif task_type == "content_generation" and complexity == "high":
            # Usa APIs premium para conte√∫do complexo
            return self.select_best_performance_api(available_apis)
        
        return self.select_balanced_api(available_apis)
    
    def track_usage(self, api_id: str, tokens_input: int, tokens_output: int):
        """Rastreia uso e calcula custos em tempo real"""
        api_config = self.get_api_config(api_id)
        cost = (
            (tokens_input / 1000) * api_config['cost_per_1k_input'] +
            (tokens_output / 1000) * api_config['cost_per_1k_output']
        )
        
        self.usage_tracker.record_usage(api_id, cost, tokens_input + tokens_output)
        return cost
```

---

## üí∞ Sistema de Gest√£o de Custos

### Dashboard de Controle
```python
class CostManagementSystem:
    def __init__(self):
        self.db = CostDatabase()
        
    def get_real_time_metrics(self):
        return {
            "today": {
                "total_cost": self.calculate_daily_cost(),
                "requests": self.count_daily_requests(),
                "tokens_used": self.count_daily_tokens(),
                "average_cost_per_request": self.calculate_avg_cost()
            },
            "monthly": {
                "total_cost": self.calculate_monthly_cost(),
                "projected_cost": self.project_monthly_cost(),
                "budget_remaining": self.calculate_budget_remaining()
            },
            "by_api": self.get_cost_breakdown_by_api(),
            "by_feature": self.get_cost_breakdown_by_feature()
        }
    
    def set_alerts(self, daily_limit: float, monthly_limit: float):
        """Configura alertas de or√ßamento"""
        if self.calculate_daily_cost() > daily_limit * 0.8:
            self.send_alert("Approaching daily limit")
        
        if self.calculate_monthly_cost() > monthly_limit * 0.8:
            self.send_alert("Approaching monthly limit")
```

### Esquema de Banco - Controle de Custos
```sql
-- Tabela de tracking de custos
CREATE TABLE api_usage_log (
    id BIGSERIAL PRIMARY KEY,
    api_provider VARCHAR(50) NOT NULL,
    api_key_id VARCHAR(100) NOT NULL,
    model_name VARCHAR(100) NOT NULL,
    request_type VARCHAR(50) NOT NULL,
    tokens_input INTEGER NOT NULL,
    tokens_output INTEGER NOT NULL,
    cost_usd DECIMAL(10,6) NOT NULL,
    response_time_ms INTEGER,
    success BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de limites e or√ßamentos
CREATE TABLE budget_limits (
    id SERIAL PRIMARY KEY,
    api_key_id VARCHAR(100) NOT NULL,
    daily_limit_usd DECIMAL(8,2),
    monthly_limit_usd DECIMAL(8,2),
    alert_threshold DECIMAL(3,2) DEFAULT 0.80,
    active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- View para m√©tricas em tempo real
CREATE VIEW real_time_costs AS
SELECT 
    api_provider,
    DATE(created_at) as usage_date,
    COUNT(*) as total_requests,
    SUM(tokens_input + tokens_output) as total_tokens,
    SUM(cost_usd) as total_cost,
    AVG(cost_usd) as avg_cost_per_request,
    AVG(response_time_ms) as avg_response_time
FROM api_usage_log 
GROUP BY api_provider, DATE(created_at)
ORDER BY usage_date DESC;
```

---

## üìö Sistema de Base de Conhecimento Inteligente

### Estrutura Hier√°rquica
```
knowledge_base/
‚îú‚îÄ‚îÄ elementary/
‚îÇ   ‚îú‚îÄ‚îÄ mathematics/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ arithmetic/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ geometry_basics/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ problem_solving/
‚îÇ   ‚îú‚îÄ‚îÄ science/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nature_studies/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ basic_physics/
‚îÇ   ‚îî‚îÄ‚îÄ language/
‚îÇ       ‚îú‚îÄ‚îÄ reading/
‚îÇ       ‚îî‚îÄ‚îÄ writing/
‚îú‚îÄ‚îÄ middle_school/
‚îÇ   ‚îú‚îÄ‚îÄ mathematics/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ algebra_intro/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ geometry/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ statistics/
‚îÇ   ‚îú‚îÄ‚îÄ science/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ biology/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chemistry/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ physics/
‚îÇ   ‚îî‚îÄ‚îÄ language/
‚îÇ       ‚îú‚îÄ‚îÄ literature/
‚îÇ       ‚îî‚îÄ‚îÄ composition/
‚îî‚îÄ‚îÄ high_school/
    ‚îú‚îÄ‚îÄ mathematics/
    ‚îÇ   ‚îú‚îÄ‚îÄ calculus/
    ‚îÇ   ‚îú‚îÄ‚îÄ trigonometry/
    ‚îÇ   ‚îî‚îÄ‚îÄ statistics_advanced/
    ‚îú‚îÄ‚îÄ science/
    ‚îÇ   ‚îú‚îÄ‚îÄ biology_advanced/
    ‚îÇ   ‚îú‚îÄ‚îÄ chemistry_advanced/
    ‚îÇ   ‚îú‚îÄ‚îÄ physics_advanced/
    ‚îÇ   ‚îî‚îÄ‚îÄ environmental/
    ‚îî‚îÄ‚îÄ language/
        ‚îú‚îÄ‚îÄ literature_analysis/
        ‚îî‚îÄ‚îÄ academic_writing/
```

### Auto-Atualiza√ß√£o de Conte√∫do
```python
class KnowledgeBaseManager:
    def __init__(self):
        self.web_crawler = EducationalWebCrawler()
        self.content_validator = ContentValidator()
        self.version_control = KnowledgeVersionControl()
    
    async def auto_update_curriculum(self, subject: str, grade_level: int):
        """Atualiza automaticamente o curr√≠culo baseado em fontes confi√°veis"""
        
        # 1. Busca de fontes confi√°veis
        reliable_sources = [
            "Khan Academy",
            "Coursera",
            "edX", 
            "MIT OpenCourseWare",
            "Brasil Escola",
            "Nova Escola"
        ]
        
        # 2. Crawling inteligente
        new_content = await self.web_crawler.crawl_educational_content(
            subject=subject,
            grade_level=grade_level,
            sources=reliable_sources,
            content_types=["text", "examples", "exercises"]
        )
        
        # 3. Valida√ß√£o e qualidade
        validated_content = await self.content_validator.validate(
            content=new_content,
            criteria=["accuracy", "age_appropriate", "curriculum_aligned"]
        )
        
        # 4. Gera√ß√£o de embeddings
        embeddings = await self.generate_embeddings(validated_content)
        
        # 5. Armazenamento versionado
        await self.version_control.store_new_version(
            subject=subject,
            grade_level=grade_level,
            content=validated_content,
            embeddings=embeddings
        )
        
        return f"Updated {len(validated_content)} items for {subject} grade {grade_level}"
    
    async def generate_dynamic_exercises(self, topic: str, difficulty: str):
        """Gera exerc√≠cios din√¢micos baseados no t√≥pico"""
        
        base_knowledge = await self.retrieve_topic_knowledge(topic)
        
        exercise_prompt = f"""
        Baseado no conhecimento de {topic}, gere 5 exerc√≠cios √∫nicos com:
        - N√≠vel de dificuldade: {difficulty}
        - Varia√ß√µes nos valores num√©ricos
        - Diferentes contextos de aplica√ß√£o
        - Explica√ß√£o passo-a-passo das solu√ß√µes
        
        Conhecimento base:
        {base_knowledge}
        """
        
        generated_exercises = await self.llm_call(exercise_prompt)
        
        # Armazena exerc√≠cios gerados para reutiliza√ß√£o futura
        await self.store_generated_content(
            content_type="exercises",
            topic=topic,
            difficulty=difficulty,
            content=generated_exercises
        )
        
        return generated_exercises
```

---

## üåê API de Comunica√ß√£o com TeacH

### Especifica√ß√£o da API
```python
from fastapi import FastAPI, HTTPException, Depends
from pydantic import BaseModel
import asyncio

app = FastAPI(title="TeacH RAG API", version="1.0.0")

class ChatRequest(BaseModel):
    user_message: str
    assistant_id: str
    subject: str
    grade_level: int
    user_profile: dict
    conversation_history: list = []

class ChatResponse(BaseModel):
    response: str
    sources: list
    generated_exercises: list = []
    cost_info: dict
    processing_time_ms: int

@app.post("/chat", response_model=ChatResponse)
async def process_chat_request(
    request: ChatRequest,
    api_key: str = Depends(validate_api_key)
):
    """Endpoint principal para processar mensagens do chat"""
    
    start_time = time.time()
    
    try:
        # 1. Valida√ß√£o de entrada
        if not request.user_message.strip():
            raise HTTPException(400, "Message cannot be empty")
        
        # 2. Recupera√ß√£o de contexto relevante
        relevant_context = await rag_system.retrieve_context(
            query=request.user_message,
            subject=request.subject,
            grade_level=request.grade_level,
            top_k=5
        )
        
        # 3. Sele√ß√£o inteligente de API
        selected_api = api_balancer.select_best_api(
            task_type="educational_chat",
            complexity=analyze_complexity(request.user_message)
        )
        
        # 4. Gera√ß√£o de resposta
        response = await generate_educational_response(
            user_message=request.user_message,
            context=relevant_context,
            assistant_profile=get_assistant_profile(request.assistant_id),
            api_config=selected_api
        )
        
        # 5. Gera√ß√£o din√¢mica de exerc√≠cios (se aplic√°vel)
        exercises = []
        if should_generate_exercises(request.user_message):
            exercises = await generate_related_exercises(
                topic=extract_topic(request.user_message),
                grade_level=request.grade_level
            )
        
        # 6. Tracking de custos
        cost_info = cost_manager.track_request(
            api_id=selected_api['id'],
            tokens_input=count_tokens(request.user_message + str(relevant_context)),
            tokens_output=count_tokens(response)
        )
        
        processing_time = int((time.time() - start_time) * 1000)
        
        return ChatResponse(
            response=response,
            sources=[ctx['source'] for ctx in relevant_context],
            generated_exercises=exercises,
            cost_info=cost_info,
            processing_time_ms=processing_time
        )
        
    except Exception as e:
        logger.error(f"Chat processing error: {str(e)}")
        raise HTTPException(500, f"Internal error: {str(e)}")

@app.post("/knowledge/update")
async def trigger_knowledge_update(
    subject: str,
    grade_level: int,
    api_key: str = Depends(validate_admin_api_key)
):
    """Endpoint para triggerar atualiza√ß√£o da base de conhecimento"""
    
    task = asyncio.create_task(
        knowledge_manager.auto_update_curriculum(subject, grade_level)
    )
    
    return {"message": "Knowledge update started", "task_id": str(task)}

@app.get("/analytics/costs")
async def get_cost_analytics(
    period: str = "daily",
    api_key: str = Depends(validate_api_key)
):
    """Endpoint para analytics de custos"""
    
    return cost_manager.get_analytics(period)

@app.get("/health")
async def health_check():
    """Health check endpoint"""
    return {
        "status": "healthy",
        "version": "1.0.0",
        "services": {
            "vector_db": await check_vector_db_health(),
            "llm_apis": await check_llm_apis_health(),
            "knowledge_base": await check_knowledge_base_health()
        }
    }
```

### Autentica√ß√£o e Seguran√ßa
```python
class APIKeyManager:
    def __init__(self):
        self.redis_client = redis.Redis()
    
    def generate_api_key(self, user_id: str, permissions: list):
        """Gera nova API key com permiss√µes espec√≠ficas"""
        api_key = f"teach_rag_{secrets.token_urlsafe(32)}"
        
        key_data = {
            "user_id": user_id,
            "permissions": permissions,
            "created_at": datetime.now().isoformat(),
            "last_used": None,
            "request_count": 0,
            "active": True
        }
        
        self.redis_client.hset(f"api_key:{api_key}", mapping=key_data)
        self.redis_client.expire(f"api_key:{api_key}", 86400 * 365)  # 1 year
        
        return api_key
    
    async def validate_api_key(self, api_key: str):
        """Valida API key e atualiza last_used"""
        key_data = self.redis_client.hgetall(f"api_key:{api_key}")
        
        if not key_data or not key_data.get("active", "false") == "true":
            raise HTTPException(401, "Invalid or inactive API key")
        
        # Atualiza last_used e incrementa contador
        self.redis_client.hset(
            f"api_key:{api_key}",
            mapping={
                "last_used": datetime.now().isoformat(),
                "request_count": int(key_data.get("request_count", 0)) + 1
            }
        )
        
        return json.loads(key_data)
```

---

## üìã Plano de Desenvolvimento

### Fase 1: Funda√ß√£o (4-6 semanas)
**Objetivos:**
- ‚úÖ Setup inicial da arquitetura
- ‚úÖ Integra√ß√£o Supabase Vector
- ‚úÖ Sistema b√°sico de embeddings
- ‚úÖ API REST fundamental

**Deliverables:**
- [ ] Estrutura do projeto Python/FastAPI
- [ ] Conex√£o Supabase Vector funcionando
- [ ] Pipeline b√°sico de gera√ß√£o de embeddings
- [ ] Endpoints /chat e /health funcionais
- [ ] Documenta√ß√£o API inicial

### Fase 2: Intelig√™ncia Core (6-8 semanas)
**Objetivos:**
- ‚úÖ Sistema multi-LLM completo
- ‚úÖ Balanceador inteligente de APIs
- ‚úÖ Gest√£o de custos em tempo real
- ‚úÖ Integra√ß√£o MCP tools

**Deliverables:**
- [ ] Balanceador de APIs funcionando
- [ ] Dashboard de custos em tempo real
- [ ] Integra√ß√£o com DuckDuckGo, Wikipedia
- [ ] Sistema de fallback inteligente
- [ ] M√©tricas de performance

### Fase 3: Base de Conhecimento (6-10 semanas)
**Objetivos:**
- ‚úÖ Crawler de conte√∫do educacional
- ‚úÖ Valida√ß√£o autom√°tica de qualidade
- ‚úÖ Gera√ß√£o din√¢mica de exerc√≠cios
- ‚úÖ Sistema de versionamento

**Deliverables:**
- [ ] Web crawler para fontes educacionais
- [ ] Validador de conte√∫do IA
- [ ] Gerador autom√°tico de exerc√≠cios
- [ ] Sistema de cache inteligente
- [ ] Interface de admin para conhecimento

### Fase 4: Integra√ß√£o e Otimiza√ß√£o (4-6 semanas)
**Objetivos:**
- ‚úÖ Integra√ß√£o completa com TeacH
- ‚úÖ Otimiza√ß√£o de performance
- ‚úÖ Sistema de monitoramento
- ‚úÖ Deploy production-ready

**Deliverables:**
- [ ] SDK para integra√ß√£o TeacH
- [ ] Sistema de monitoring completo
- [ ] Otimiza√ß√µes de cache e performance
- [ ] CI/CD pipeline
- [ ] Documenta√ß√£o completa

---

## üíµ Or√ßamento e Estrat√©gia de Custos

### Custos Iniciais (Mensal)

#### Infraestrutura - FREE TIER
```
‚úÖ Supabase Vector DB: $0/m√™s (500MB, 2M requests)
‚úÖ Vercel Hosting: $0/m√™s (100GB bandwidth)
‚úÖ ChromaDB Backup: $0/m√™s (100K docs)
‚úÖ Redis (Upstash): $0/m√™s (10K requests/day)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total Infraestrutura: $0/m√™s
```

#### APIs LLM - ESTRAT√âGIA H√çBRIDA
```
üÜì OpenRouter (Free Models): $0/m√™s
   - llama-3.1-8b-instruct:free
   - qwen-2-7b-instruct:free
   
üí∞ OpenAI (GPT-4o-mini): ~$5-15/m√™s
   - $0.000150/$0.000600 per 1K tokens
   - Estimativa: 500K tokens/m√™s
   
üí∞ Anthropic (Claude Haiku): ~$3-10/m√™s
   - $0.00025/$0.00125 per 1K tokens
   - Para tarefas espec√≠ficas
   
üí∞ Google (Gemini Flash): ~$1-5/m√™s
   - $0.000125/$0.000375 per 1K tokens
   - Processamento de grandes volumes
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total APIs: $9-30/m√™s (in√≠cio conservador)
```

#### Desenvolvimento
```
üë®‚Äçüíª Desenvolvimento: $0 (voc√™)
üîß Ferramentas: $0 (todas free tier)
üìö Recursos: $0 (documenta√ß√£o open source)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total: $9-30/m√™s para come√ßar
```

### Estrat√©gia de Escalabilidade
```python
class CostOptimizationStrategy:
    def __init__(self):
        self.usage_thresholds = {
            "low": {"requests": 1000, "budget": 30},
            "medium": {"requests": 10000, "budget": 100},
            "high": {"requests": 50000, "budget": 300}
        }
    
    def recommend_scaling(self, current_usage: dict):
        """Recomenda ajustes baseado no uso atual"""
        
        if current_usage["monthly_requests"] < 1000:
            return {
                "infrastructure": "free_tier_only",
                "llm_strategy": "free_models_priority",
                "estimated_cost": 0
            }
        elif current_usage["monthly_requests"] < 10000:
            return {
                "infrastructure": "upgrade_vector_db",
                "llm_strategy": "balanced_free_paid",
                "estimated_cost": 50
            }
        else:
            return {
                "infrastructure": "professional_tier",
                "llm_strategy": "performance_optimized",
                "estimated_cost": 200
            }
```

---

## üö® Gest√£o de Riscos

### Riscos T√©cnicos
| Risco | Probabilidade | Impacto | Mitiga√ß√£o |
|-------|---------------|---------|-----------|
| **API Limits Exceeded** | M√©dia | Alto | Sistema de quotas + fallback gratuito |
| **Vector DB Latency** | Baixa | M√©dio | Cache Redis + m√∫ltiplas conex√µes |
| **LLM API Downtime** | M√©dia | Alto | Multi-provider + fallback local |
| **Cost Overrun** | Alta | Alto | Alertas autom√°ticos + circuit breakers |

### Riscos de Neg√≥cio
| Risco | Probabilidade | Impacto | Mitiga√ß√£o |
|-------|---------------|---------|-----------|
| **Baixa Ado√ß√£o** | M√©dia | Alto | MVP focado + feedback cont√≠nuo |
| **Competi√ß√£o** | Alta | M√©dio | Features √∫nicas + integra√ß√£o profunda |
| **Mudan√ßas Regulat√≥rias** | Baixa | Alto | Compliance LGPD + auditoria |

### Circuit Breakers
```python
class SystemCircuitBreaker:
    def __init__(self):
        self.daily_budget = 30.0
        self.monthly_budget = 300.0
        self.request_threshold = 1000
        
    def check_limits(self):
        current_cost = cost_manager.get_daily_cost()
        current_requests = cost_manager.get_daily_requests()
        
        if current_cost > self.daily_budget * 0.9:
            return self.activate_emergency_mode("cost_limit")
        
        if current_requests > self.request_threshold:
            return self.activate_rate_limiting("request_limit")
        
        return {"status": "normal", "limits_ok": True}
    
    def activate_emergency_mode(self, reason: str):
        """Ativa modo de emerg√™ncia com apenas modelos gratuitos"""
        return {
            "status": "emergency",
            "reason": reason,
            "allowed_apis": ["openrouter_free"],
            "action": "switch_to_free_tier_only"
        }
```

---

## üîÑ Integra√ß√£o com Plataforma TeacH

### SDK de Integra√ß√£o
```typescript
// teach-rag-sdk.ts
class TeachRAGClient {
    constructor(
        private apiKey: string,
        private baseUrl: string = 'https://rag.teach.com'
    ) {}
    
    async sendMessage(params: {
        message: string;
        assistantId: string;
        subject: string;
        gradeLevel: number;
        userProfile: UserProfile;
        conversationHistory?: Message[];
    }): Promise<RAGResponse> {
        
        const response = await fetch(`${this.baseUrl}/chat`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${this.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
        });
        
        if (!response.ok) {
            throw new RAGError(`API error: ${response.status}`);
        }
        
        return await response.json();
    }
    
    async getCostAnalytics(period: 'daily' | 'weekly' | 'monthly' = 'daily') {
        const response = await fetch(`${this.baseUrl}/analytics/costs?period=${period}`, {
            headers: { 'Authorization': `Bearer ${this.apiKey}` }
        });
        
        return await response.json();
    }
    
    async triggerKnowledgeUpdate(subject: string, gradeLevel: number) {
        const response = await fetch(`${this.baseUrl}/knowledge/update`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${this.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ subject, gradeLevel })
        });
        
        return await response.json();
    }
}
```

### Modifica√ß√µes no TeacH (M√≠nimas)
```typescript
// services/ai-service.ts - Modifica√ß√£o no m√©todo existente
export class AIService {
    private ragClient: TeachRAGClient;
    
    constructor() {
        this.ragClient = new TeachRAGClient(
            process.env.TEACH_RAG_API_KEY!,
            process.env.TEACH_RAG_URL
        );
    }
    
    async sendMessage(
        userMessage: string, 
        assistant: Assistant, 
        profile: UserProfile
    ): Promise<string> {
        
        try {
            // Primeira tentativa: RAG System
            const ragResponse = await this.ragClient.sendMessage({
                message: userMessage,
                assistantId: assistant.id,
                subject: assistant.subject,
                gradeLevel: profile.gradeLevel,
                userProfile: profile
            });
            
            // Sucesso com RAG
            return ragResponse.response + 
                   (ragResponse.generated_exercises.length > 0 
                    ? '\n\nüìö **Exerc√≠cios relacionados:**\n' + 
                      ragResponse.generated_exercises.join('\n')
                    : '');
                    
        } catch (error) {
            console.warn('RAG unavailable, using fallback:', error);
            
            // Fallback: sistema atual (j√° implementado)
            return this.generateFallbackResponse(userMessage, assistant, profile);
        }
    }
}
```

---

## üìà M√©tricas de Sucesso

### KPIs T√©cnicos
```python
class SuccessMetrics:
    def __init__(self):
        self.targets = {
            "response_time_p95": 2000,  # ms
            "accuracy_rate": 0.85,      # 85%
            "cost_per_request": 0.01,   # $0.01
            "uptime": 0.99,             # 99%
            "cache_hit_rate": 0.70      # 70%
        }
    
    def calculate_monthly_report(self):
        return {
            "technical_kpis": {
                "avg_response_time": self.get_avg_response_time(),
                "accuracy_score": self.calculate_accuracy_score(),
                "cost_efficiency": self.calculate_cost_efficiency(),
                "system_uptime": self.calculate_uptime(),
                "cache_performance": self.get_cache_metrics()
            },
            "business_kpis": {
                "user_satisfaction": self.get_satisfaction_score(),
                "engagement_improvement": self.calculate_engagement_delta(),
                "cost_savings": self.calculate_cost_savings(),
                "knowledge_growth": self.calculate_kb_growth()
            }
        }
```

### Objetivos de Neg√≥cio
- üìà **Engajamento**: +40% tempo de sess√£o no chat
- üí∞ **Economia**: -60% custo por resposta vs. APIs diretas
- üéØ **Precis√£o**: 90%+ respostas relevantes educacionalmente
- üöÄ **Performance**: <2s tempo de resposta P95
- üìö **Cobertura**: 100% curr√≠culo brasileiro 1¬∫-3¬∫ ano

---

## üöÄ Roadmap de Implementa√ß√£o

### Sprint 1-2 (2 semanas): Funda√ß√£o
```bash
‚úÖ Setup projeto Python + FastAPI
‚úÖ Configura√ß√£o Supabase Vector
‚úÖ Estrutura b√°sica de embeddings
‚úÖ Endpoint /chat MVP
‚úÖ Testes automatizados iniciais
```

### Sprint 3-4 (2 semanas): Multi-LLM Core
```bash
‚úÖ Sistema de configura√ß√£o de APIs
‚úÖ Balanceador inteligente
‚úÖ Tracking de custos b√°sico
‚úÖ Fallback system
‚úÖ Integra√ß√£o OpenRouter free models
```

### Sprint 5-6 (2 semanas): MCP & Tools
```bash
‚úÖ Integra√ß√£o LangChain MCP
‚úÖ Web search (DuckDuckGo)
‚úÖ Wikipedia integration
‚úÖ Calculator tool
‚úÖ Content validation pipeline
```

### Sprint 7-8 (2 semanas): Knowledge Base
```bash
‚úÖ Web crawler educacional
‚úÖ Auto-update curriculum
‚úÖ Content quality validation
‚úÖ Exercise generation engine
‚úÖ Knowledge versioning
```

### Sprint 9-10 (2 semanas): Production Ready
```bash
‚úÖ SDK para TeacH integration
‚úÖ Monitoring & alerting
‚úÖ Performance optimization
‚úÖ Security hardening
‚úÖ CI/CD pipeline
```

### Sprint 11-12 (2 semanas): Advanced Features
```bash
‚úÖ Advanced analytics dashboard
‚úÖ A/B testing framework
‚úÖ Machine learning optimization
‚úÖ Advanced caching strategies
‚úÖ Documentation completa
```

---

## üîß Considera√ß√µes de Deploy

### Op√ß√µes de Hospedagem

#### Op√ß√£o 1: Vercel (Recomendado para MVP)
```yaml
# vercel.json
{
  "builds": [
    {
      "src": "main.py",
      "use": "@vercel/python"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "main.py"
    }
  ],
  "env": {
    "SUPABASE_URL": "@supabase_url",
    "SUPABASE_KEY": "@supabase_key",
    "OPENAI_API_KEY": "@openai_key"
  }
}
```

**Vantagens:**
- ‚úÖ Deploy simples e r√°pido
- ‚úÖ Escala autom√°tico
- ‚úÖ Free tier generoso
- ‚úÖ Edge functions

#### Op√ß√£o 2: Railway (Backup)
```dockerfile
# Dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### Op√ß√£o 3: Fly.io (Para scale)
```toml
# fly.toml
app = "teach-rag-system"

[build]
  builder = "paketobuildpacks/builder:base"

[[services]]
  internal_port = 8000
  protocol = "tcp"

  [services.concurrency]
    hard_limit = 25
    soft_limit = 20

  [[services.ports]]
    handlers = ["http"]
    port = 80

  [[services.ports]]
    handlers = ["tls", "http"]
    port = 443
```

---

## üìã Conclus√£o

### Resumo Executivo
Este projeto RAG representa uma evolu√ß√£o estrat√©gica da plataforma TeacH, transformando-a de um sistema dependente de APIs externas para uma solu√ß√£o educacional aut√¥noma e inteligente.

### Benef√≠cios Principais
1. **üîß Autonomia Operacional**: Redu√ß√£o de 80% da depend√™ncia de APIs externas
2. **üí∞ Efici√™ncia de Custos**: Economia de 60% nos custos de IA
3. **üìö Qualidade Educacional**: Conte√∫do validado e atualizado automaticamente
4. **‚ö° Performance**: Respostas 3x mais r√°pidas com cache inteligente
5. **üéØ Personaliza√ß√£o**: Experi√™ncia adaptada por usu√°rio e contexto

### Pr√≥ximos Passos
1. **‚úÖ Aprova√ß√£o do escopo** e valida√ß√£o de requisitos
2. **üöÄ In√≠cio do desenvolvimento** com Sprint 1
3. **üîÑ Itera√ß√£o cont√≠nua** com feedback semanal
4. **üìä M√©tricas de progresso** e ajustes de rota
5. **üéØ Deploy MVP** em 6-8 semanas

### Investimento Total Estimado
- **üíª Desenvolvimento**: $0 (interno)
- **üèóÔ∏è Infraestrutura**: $0-30/m√™s (in√≠cio)
- **‚è±Ô∏è Tempo**: 10-12 semanas
- **üìà ROI Esperado**: 300%+ em 6 meses

---

**Este projeto posiciona a TeacH como l√≠der em educa√ß√£o assistida por IA no Brasil, com tecnologia de ponta, custos otimizados e experi√™ncia superior para estudantes e educadores.**

> üéØ **Pronto para transformar a educa√ß√£o brasileira com IA inteligente e acess√≠vel?**